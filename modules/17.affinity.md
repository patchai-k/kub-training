# Taints, Tolerations and Affinity

## Module Objectives

- Use node affinity with a deployment

---

## Use Node Selection with a deployment.

- Get the list of nodes in your kubernetes cluster:

    ```shell
    kubectl get nodes
    ```

  Show the nodes with the labels:

    ```shell
    kubectl get nodes --show-labels
    ```

    Describe the node to see the labels:

    ```shell
    kubectl describe node <SELECT-A-NODE FROM-ABOVE> | less
    ```

    Inspect the **Labels** section.

    Add a custom label to just one node:

    ```shell
    kubectl label nodes <SELECT-A-NODE FROM-ABOVE> gpu=amd
    ```

    See the label on the node:

    ```shell
    kubectl describe node <SELECT-A_NODE-FROM-ABOVE> | less
    ```

    Create a deployment manifest named nginx.yaml with an **affinity**
    section:

    ```yaml
    apiVersion: apps/v1
    kind: Deployment
    metadata:
      name: nginx
    spec:
      selector:
        matchLabels:
          app: nginx
      replicas: 1
      template:
        metadata:
          labels:
            app: nginx
        spec:
          containers:
          - name: nginx
            image: nginx:1.17.3
            ports:
            - containerPort: 80
          affinity:
            nodeAffinity:
              requiredDuringSchedulingIgnoredDuringExecution:
                nodeSelectorTerms:
                - matchExpressions:
                  - key: gpu
                    operator: In
                    values:
                    - amd
    ```

    Create the deployment.
    Verify the pod is running on the correct node.

    ```shell
        kubectl get pods -o wide
    ```

    Scale up the deployment and verify all pods are all running
    on the correct node:

    ```shell
    kubectl scale deployment nginx --replicas=5
    ```

    Delete the deployment.

    Remove the label from the node:

    ```shell
    kubectl label nodes <SELECT-A-NODE FROM-ABOVE> gpu-
    ```

    Verify the label was removed from the node.

    ---

    ## **IMPORTANT CLEANUP**
    Run the following to cleanup your environment

    ```shell
    ~/kubernetes-training/starting-points/cleanup.sh affinity
    ```
