# Pods

## Module Objectives

1. Deploy the sample app to Kubernetes
1. Deploy a pod using a custom image
1. Use exec to connect to deployed running container inside a pod

## Deploy the Sample App to Kubernetes

In this section, you will deploy the mysql database, `gceme` frontend and backend apps to Kubernetes. We will use Kubernetes manifest files to describe the environment that the `gceme` binary/Docker image will be deployed to. We will use the `gceme` Docker image that you built in a previous module.

1. Create the manifest to deploy the `db` MySQL Pod. Save the following as `db.yaml`:

    ```yaml
    apiVersion: v1
    kind: Pod
    metadata:
      name: db
    spec:
      containers:
      - image: mysql:5.6
        name: mysql
        env:
        - name: MYSQL_ROOT_PASSWORD
          value: very-secret-password
        ports:
        - containerPort: 3306
          name: mysql
    ```

    > Note: `mysql` is a public image, available on hub.docker.com. If we do not specify a full registry url such as gcr.io it will check the default Docker Hub registry.

1. Deploy the `db` Pod to Kubernetes.

    ```shell
    kubectl apply -f db.yaml
    ```
1. List all Pods.

    ```shell
    kubectl get pod
    ```

    ```
    NAME      READY     STATUS    RESTARTS   AGE
    db        1/1       Running   0          17s
    ```

1. Find out the `db` Pod IP address.

    ```shell
    kubectl describe pod db | grep IP
    ```

    It is also useful to take a look at the full output of the `kubectl describe pod` command.

    You can also use the following command to find the IP address
    of the pod:
    ```shell
    kubectl get pods -o wide
    ```

1. Get your uploaded container image from Google Container Registry. PROJECT_ID should be set automatically as part of a previous exercise. This image will be used for our three tier application in our manifests.

    ```shell
    echo $PROJECT_ID
    export IMAGE=gcr.io/$PROJECT_ID/sample-k8s-app:1.0.0
    echo $IMAGE
    ```

1. Create the manifest for the `backend` application. Save it as `backend.yaml` and deploy it to Kubernetes using `kubectl apply` command.

    ```yaml
    kind: Pod
    apiVersion: v1
    metadata:
      name: backend
    spec:
      containers:
      - name: backend
        image: <REPLACE_WITH_YOUR_OWN_IMAGE>
        command: ["app", "-mode=backend", "-run-migrations", "-port=8080", "-db-host=<REPLACE_WITH_MYSQL_IP>", "-db-password=very-secret-password" ]
        ports:
        - name: backend
          containerPort: 8080
    ```

    > Important: Replace the image and the MySQL `db` pod's ip address.

1. Find out the `backend` Pod IP address just like how we did for the `db` Pod.

1. Create the manifest for the `frontend` application. Save it as `frontend.yaml` and deploy it to Kubernetes using `kubectl apply` command.

    ```yaml
    kind: Pod
    apiVersion: v1
    metadata:
      name: frontend
    spec:
      containers:
      - name: frontend
        image: <REPLACE_WITH_YOUR_OWN_IMAGE>
        command: ["app", "-mode=frontend", "-backend-service=http://<REPLACE_WITH_BACKEND_IP>:8080", "-port=80"]
        ports:
        - name: frontend
          containerPort: 80
    ```

    > Important: Replace the image and the `backend` ip address.

1. Find out the `frontend` pod IP address.

1. In the Cloud Console go to the **Compute Engine -> VM instances** page and
`ssh` to any of the worker nodes. Pods have only cluster-internal IP addresses and are not available from the outside by default.

1. From the node try to connect to both the `backend` and `frontend` using curl.

    ```shell
    curl <backend-ip>:8080
    curl <frontend-ip>
    ```


## Optional Exercises

### Deploy a pod using different image.

Create a pod that runs [nginx](https://hub.docker.com/_/nginx) image. Try to access nginx.

### Manually connect to mysql DB from app pod

1. Go inside the backend pod. (Use [exec](https://kubernetes.io/docs/tasks/debug-application-cluster/get-shell-running-container/) command to do that)
1. Use `mysql-client` package to install [mysql](https://dev.mysql.com/doc/refman/8.0/en/mysql.html)
1. Use `mysql` to connect to the DB.

---

## **IMPORTANT CLEANUP**
Run the following to cleanup your environment

```shell
~/kubernetes-training/starting-points/cleanup.sh pods
```
